<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Cutoff Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Bright & Educational Theme */
        body { 
            background-color: #f8fafc; 
            color: #334155; 
            min-height: 100vh; 
            font-family: 'Poppins', sans-serif;
        }
        
        .glass-card { 
            background: #ffffff; 
            border: 1px solid #e2e8f0; 
            border-radius: 24px; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        
        .glass-card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); 
            border-color: #fdba74;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; 
            border-radius: 24px; width: 95%; max-width: 900px;
            max-height: 85vh; overflow-y: auto; position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            padding: 2rem;
        }
        .spec-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem;
        }
        .spec-item {
            background: #f8fafc; padding: 1rem; border-radius: 16px;
            display: flex; align-items: center; gap: 1rem; text-align: left;
            cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent;
        }
        .spec-item:hover {
            background: #fff; border-color: #f97316; transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }
        .spec-item.active { border-color: #f97316; background: #fff7ed; }
        .spec-item .icon { font-size: 1.8rem; flex-shrink: 0; }
        .spec-item .text { font-weight: 700; font-size: 0.95rem; color: #2d3748; line-height: 1.3; }

        /* Custom Form Styling */
        .form-field {
            border: 1px solid #cbd5e0;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 0.95rem;
            font-weight: 500;
            color: #2d3748;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            transition: all 0.2s ease;
        }
        .form-field:hover { border-color: #a0aec0; box-shadow: 0 4px 8px rgba(0,0,0,0.08); transform: translateY(-1px); }
        .form-field:focus { 
            border-color: #f97316; background-color: #fff; 
            box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.15); outline: none; 
        }
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%234a5568' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-10">
            <div>
                <div class="flex items-center gap-4">
                    <a href="/" class="bg-white hover:bg-orange-50 text-orange-500 p-3 rounded-full transition shadow-sm text-xl border border-orange-100" title="Back to Departments">‚¨ÖÔ∏è</a>
                    <div>
                        <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-amber-500 drop-shadow-sm">
                            {{ selected_department if selected_department else 'All' }} Colleges (Round {{ selected_round }})
                        </h1>
                        <p class="text-gray-600 mt-1 text-lg font-medium">Select Branch & Check Cutoffs</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Filters Section -->
        <div class="glass-card p-8 mb-8">
            <form id="filterForm" action="/colleges" method="GET" class="flex flex-wrap items-end gap-3">
                <!-- Hidden Specialty Input -->
                <input type="hidden" name="specialty" id="specialtyInput" value="{{ selected_specialty or '' }}">
                <input type="hidden" name="department" value="{{ selected_department or '' }}">
                <input type="hidden" name="round" value="{{ selected_round or '1' }}">
                <input type="hidden" name="page" id="pageInput" value="{{ page }}">
                
                <!-- Search Bar -->
                <div class="flex-grow min-w-[200px]">
                    <label class="block text-sm text-gray-600 font-bold mb-1">Search College</label>
                    <input type="text" name="search" id="searchInput" placeholder="e.g. IIT, Medical..." value="{{ request.args.get('search', '') }}" class="w-full form-field">
                </div>
                <div class="flex-grow min-w-[150px]">
                    <label class="block text-sm text-gray-600 font-bold mb-1">Quota</label>
                    <select name="gender" class="w-full form-field form-select">
                        <option value="">All Quotas</option>
                        <option value="Home District" {% if selected_gender == 'Home District' %}selected{% endif %}>Home District</option>
                        <option value="Other than Home District" {% if selected_gender == 'Other than Home District' %}selected{% endif %}>Other than Home District</option>
                        <option value="State Level" {% if selected_gender == 'State Level' %}selected{% endif %}>State Level</option>
                    </select>
                </div>
                <div class="flex-grow min-w-[150px]">
                    <label class="block text-sm text-gray-600 font-bold mb-1">Category</label>
                    <select name="category" class="w-full form-field form-select">
                        <option value="">All Categories</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}" {% if selected_category == cat %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flex-grow min-w-[150px]">
                    <label class="block text-sm text-gray-600 font-bold mb-1">Seat Type</label>
                    <select name="seat_type" class="w-full form-field form-select">
                        <option value="">All Seat Types</option>
                        {% for seat in seat_types %}
                        <option value="{{ seat }}" {% if selected_seat_type == seat %}selected{% endif %}>{{ seat }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="w-[120px] flex-none">
                    <label class="block text-sm text-gray-600 font-bold mb-1">Your Rank</label>
                    <input type="number" name="rank" id="rankInput" min="1" oninput="if(this.value < 0) this.value = 0;" placeholder="e.g. 5000" value="{{ selected_rank }}" class="w-full form-field">
                </div>
                
                <!-- Specialty Button (Right Side) -->
                <button type="button" onclick="openModal()" class="flex-grow bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg transform active:scale-95 flex items-center justify-center gap-2 h-[50px]">
                    <span id="specBtnText">{{ selected_specialty if selected_specialty else 'Select Branch' }}</span> ‚ñæ
                </button>
            </form>
        </div>

        <div id="doctorsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% if selected_specialty %}
            {% for doctor in doctors %}
            <div class="glass-card p-6 flex flex-col items-center text-center">
                <div class="w-full h-40 rounded-xl bg-gradient-to-br from-orange-100 to-amber-100 mb-4 flex items-center justify-center">
                    <span class="text-4xl">üè´</span>
                </div>
                <h3 class="text-xl font-bold text-gray-800 cursor-pointer hover:text-orange-600 transition" onclick="this.parentElement.querySelector('button').click()">{{ doctor.name }}</h3>
                
                <div class="w-full mt-4 space-y-2 text-left px-2">
                    <div class="flex justify-between border-b border-gray-100 pb-2">
                        <span class="text-gray-500 text-xs font-bold uppercase">Category</span>
                        <span class="text-gray-800 font-semibold text-sm">{{ doctor.qualification }}</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-100 pb-2">
                        <span class="text-gray-500 text-xs font-bold uppercase">Rank</span>
                        <span class="text-orange-600 font-bold text-sm">{{ doctor.rank }}</span>
                    </div>
                    <div class="flex justify-between pb-2">
                        <span class="text-gray-500 text-xs font-bold uppercase">Quota</span>
                        <span class="text-gray-800 font-semibold text-sm">{{ doctor.gender }}</span>
                    </div>
                </div>

                <button onclick="openDetailsModal(this)" data-doctor="{{ doctor | tojson | forceescape }}" class="w-full mt-4 py-3 bg-white border-2 border-orange-500 text-orange-600 hover:bg-orange-50 rounded-xl font-bold transition shadow-sm transform active:scale-95">
                    More Details
                </button>
            </div>
            {% else %}
            <div class="col-span-full text-center py-10">
                <p class="text-gray-600 text-xl">No colleges found matching your criteria.</p>
                <a href="/" class="text-orange-500 hover:underline mt-2 inline-block font-bold">Clear Filters</a>
            </div>
            {% endfor %}

            {% if total_pages > 1 %}
            <div class="col-span-full flex justify-center items-center gap-4 mt-8 py-4 border-t border-gray-100">
                <button onclick="changePage({{ page - 1 }})" class="px-6 py-2 bg-white border border-gray-200 rounded-xl font-bold text-gray-600 hover:bg-orange-50 hover:text-orange-600 hover:border-orange-200 transition disabled:opacity-50 disabled:cursor-not-allowed" {% if page <= 1 %}disabled{% endif %}>Previous</button>
                <span class="text-gray-600 font-bold">Page {{ page }} of {{ total_pages }}</span>
                <button onclick="changePage({{ page + 1 }})" class="px-6 py-2 bg-white border border-gray-200 rounded-xl font-bold text-gray-600 hover:bg-orange-50 hover:text-orange-600 hover:border-orange-200 transition disabled:opacity-50 disabled:cursor-not-allowed" {% if page >= total_pages %}disabled{% endif %}>Next</button>
            </div>
            {% endif %}

            {% else %}
            <div class="col-span-full text-center py-16">
                <p class="text-gray-500 text-2xl font-bold">üëà Please select a Branch to view colleges.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Specialty Modal -->
    <div id="specModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content animate__animated animate__zoomIn">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Choose Branch</h2>
                <button onclick="document.getElementById('specModal').style.display='none'" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            
            <div class="mb-4">
                <input type="text" id="branchSearch" onkeyup="filterBranches()" placeholder="Search branches..." class="w-full form-field">
            </div>

            <div class="spec-grid">
                <div class="spec-item {{ 'active' if not selected_specialty }}" onclick="selectSpecialty('')">
                    <div class="icon">üè•</div>
                    <div class="text">All Branches</div>
                </div>
                {% for spec in specialties %}
                <div class="spec-item {{ 'active' if spec.name == selected_specialty }}" onclick="selectSpecialty('{{ spec.name }}')">
                    <div class="icon">{{ spec.icon }}</div> 
                    <div class="text">{{ spec.name }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- College Details Modal -->
    <div id="detailsModal" class="modal-overlay" onclick="closeDetailsModal(event)">
        <div class="modal-content animate__animated animate__zoomIn overflow-y-auto">
            
            <!-- Header with Gradient -->
            <div class="relative h-40 bg-gradient-to-r from-orange-500 to-amber-500 flex items-end p-6">
                <button onclick="closeDetailsModalBtn()" class="absolute top-4 right-4 text-white/80 hover:text-white text-4xl font-bold transition leading-none">&times;</button>
                <h2 id="modalTitle" class="text-2xl md:text-3xl font-bold text-white shadow-black/20 drop-shadow-md leading-tight mb-2"></h2>
            </div>

            <div class="p-6 md:p-8">
                <!-- Image & Basic Info Wrapper -->
                <div class="flex flex-col md:flex-row gap-6 mb-8">
                    <img id="modalImage" src="" alt="College Image" class="w-full md:w-1/3 h-40 object-cover rounded-2xl shadow-lg border-4 border-white -mt-16 bg-white">
                    
                    <div class="flex-1 grid grid-cols-2 gap-3">
                        <div class="bg-orange-50 p-3 rounded-xl border border-orange-100">
                            <span class="block text-orange-500 text-xs font-bold uppercase tracking-wider mb-1">Branch</span>
                            <span id="modalSpecialty" class="text-sm md:text-base font-bold text-gray-800 leading-tight"></span>
                        </div>
                        <div class="bg-amber-50 p-3 rounded-xl border border-amber-100">
                            <span class="block text-amber-600 text-xs font-bold uppercase tracking-wider mb-1">Cutoff</span>
                            <span id="modalCutoff" class="text-xl font-extrabold text-amber-600"></span>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                            <span class="block text-gray-500 text-xs font-bold uppercase tracking-wider mb-1">Quota</span>
                            <span id="modalLocation" class="text-sm font-bold text-gray-800"></span>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                            <span class="block text-gray-500 text-xs font-bold uppercase tracking-wider mb-1">Category</span>
                            <span id="modalCategory" class="text-sm font-bold text-gray-800"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Info Section -->
                <div class="bg-gray-50 rounded-2xl p-6 border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span>üìã</span> Admission Details
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-y-6 gap-x-8 text-sm" id="modalAdditionalInfo">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="mt-8 flex justify-end">
                    <button onclick="closeDetailsModalBtn()" class="px-8 py-3 bg-gray-800 hover:bg-gray-900 text-white rounded-xl font-bold transition shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">Close Details</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Modal Logic
        function openModal() {
            document.getElementById('specModal').style.display = 'flex';
        }

        function closeModal(e) {
            if (e.target.id === 'specModal') {
                document.getElementById('specModal').style.display = 'none';
            }
        }

        function selectSpecialty(specName) {
            document.getElementById('specialtyInput').value = specName;
            document.getElementById('specBtnText').innerText = specName || 'Select Branch';
            document.getElementById('specModal').style.display = 'none';
            updateDoctors(); // Trigger update
        }

        function filterBranches() {
            const input = document.getElementById('branchSearch');
            const filter = input.value.toLowerCase();
            const items = document.getElementsByClassName('spec-item');

            for (let i = 0; i < items.length; i++) {
                const textDiv = items[i].getElementsByTagName("div")[1];
                if (textDiv) {
                    const txtValue = textDiv.textContent || textDiv.innerText;
                    items[i].style.display = txtValue.toLowerCase().indexOf(filter) > -1 ? "" : "none";
                }
            }
        }

        // Details Modal Logic
        function openDetailsModal(btn) {
            const doc = JSON.parse(btn.dataset.doctor);
            
            document.getElementById('modalTitle').innerText = doc.name;
            document.getElementById('modalImage').src = doc.image || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%23b3d9ff" width="400" height="300"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%23003d99" font-size="48" font-family="sans-serif"%3Eüè´%3C/text%3E%3C/svg%3E';
            document.getElementById('modalSpecialty').innerText = doc.specialty;
            document.getElementById('modalCutoff').innerText = doc.experience + (doc.gender === 'AI' ? ' Marks' : '%');
            document.getElementById('modalLocation').innerText = doc.gender;
            document.getElementById('modalCategory').innerText = doc.qualification || 'General';
            
            // Dynamic info from CSV
            const excludeKeys = ['name', 'image', 'specialty', 'experience', 'gender', 'qualification', 'percentile'];
            let detailsHtml = '';
            for (const [key, value] of Object.entries(doc)) {
                if (!excludeKeys.includes(key) && value !== null && value !== 'N/A' && value !== '') {
                    const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    detailsHtml += `<div class="flex flex-col border-b border-gray-200 pb-2">
                        <span class="text-gray-500 text-xs font-bold uppercase">${label}</span>
                        <span class="font-bold text-gray-800 text-lg">${value}</span>
                    </div>`;
                }
            }
            document.getElementById('modalAdditionalInfo').innerHTML = detailsHtml;
            
            document.getElementById('detailsModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeDetailsModal(e) {
            if (e.target.id === 'detailsModal') {
                document.getElementById('detailsModal').style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        function closeDetailsModalBtn() {
            document.getElementById('detailsModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        // Real-time Search & Filter Logic
        const form = document.getElementById('filterForm');
        const inputs = form.querySelectorAll('input, select');
        let debounceTimer;

        function changePage(newPage) {
            document.getElementById('pageInput').value = newPage;
            updateDoctors();
            document.getElementById('doctorsGrid').scrollIntoView({behavior: 'smooth'});
        }

        inputs.forEach(input => {
            if (input.name === 'page') return;
            const trigger = () => {
                document.getElementById('pageInput').value = 1;
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(updateDoctors, 300); // Debounce 300ms
            };
            input.addEventListener('input', trigger);
            input.addEventListener('change', trigger);
        });

        async function updateDoctors() {
            const formData = new FormData(form);
            const params = new URLSearchParams(formData);
            
            try {
                // Fetch from root '/' with params
                const response = await fetch(`/colleges?${params.toString()}`);
                const text = await response.text();
                
                // Parse HTML and replace grid
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const newGrid = doc.getElementById('doctorsGrid');
                
                document.getElementById('doctorsGrid').innerHTML = newGrid.innerHTML;
            } catch (err) {
                console.error("Error updating doctors:", err);
            }
        }
    </script>
</body>
</html>
